# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

> –ü–æ–ª–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Telegram Media Downloader

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∏—Å—Ç–æ—Ä–∏–∏)
- [–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö](#–∏–∑–æ–ª—è—Ü–∏—è-–¥–∞–Ω–Ω—ã—Ö)
- [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é](#—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–ø–∞–º—è—Ç—å—é)
- [–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](#–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
- [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

## ‚ú® –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è

–ö –±–∞–∑–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –º–æ–¥—É–ª–∏:

### üåê Web Dashboard (FastAPI + React)
- **Backend (FastAPI)**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π API –∏ WebSockets –¥–ª—è —Ä–µ–∞–ª-—Ç–∞–π–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.
- **Frontend (React)**: –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π SPA —Å –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π Recharts –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ Framer Motion –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π.
- **WebSocket**: –ñ–∏–≤–æ–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –∏–∑ `rich.progress` —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ –±—Ä–∞—É–∑–µ—Ä.

### üìä ClickHouse Integration
- **–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ**: –í—Å–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —á–∞—Ç–æ–≤ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –≤ ClickHouse.
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ü–æ–∑–≤–æ–ª—è–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–ª—É—á–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –º–∏–ª–ª–∏–æ–Ω–∞–º —Å–æ–æ–±—â–µ–Ω–∏–π.
- **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è**: –î–∞—à–±–æ—Ä–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ ClickHouse –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏

### –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞

–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:

1. **JSONL (–ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)** - –ë—ã—Å—Ç—Ä–∞—è –∑–∞–ø–∏—Å—å, –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ
2. **HTML (–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è)** - –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –ø–æ–∏—Å–∫

#### –£—Ä–æ–≤–µ–Ω—å 1: JSONL

```python
# chat_-1003334819414.jsonl
{"id": 1, "text": "...", "downloaded_file": "/path/file.jpg"}
{"id": 2, "text": "...", "downloaded_file": null}
{"id": 3, "text": "...", "downloaded_file": "/path/video.mp4"}
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –§–æ—Ä–º–∞—Ç: JSON Lines (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ = –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- –†–µ–∂–∏–º –∑–∞–ø–∏—Å–∏: `append` (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω–µ—Ü)
- –°–∫–æ—Ä–æ—Å—Ç—å: –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ (–Ω–µ—Ç —á—Ç–µ–Ω–∏—è/–ø–∞—Ä—Å–∏–Ω–≥–∞)
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

#### –£—Ä–æ–≤–µ–Ω—å 2: HTML

```html
<!-- chat_-1003334819414.html -->
<!DOCTYPE html>
<html>
  <!-- –ü–æ–ª–Ω—ã–π HTML —Å CSS, JavaScript, –≤—Å–µ–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ -->
</html>
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –§–æ—Ä–º–∞—Ç: –ü–æ–ª–Ω—ã–π HTML –¥–æ–∫—É–º–µ–Ω—Ç
- –†–µ–∂–∏–º –∑–∞–ø–∏—Å–∏: `overwrite` (–ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å)
- –°–∫–æ—Ä–æ—Å—Ç—å: –ú–µ–¥–ª–µ–Ω–Ω–æ (—á—Ç–µ–Ω–∏–µ JSONL + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

```
–ó–ê–ì–†–£–ó–ö–ê –ü–ê–ö–ï–¢–ê –°–û–û–ë–©–ï–ù–ò–ô (100 —à—Ç)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. download_media() –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
   ‚îú‚îÄ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
   ‚îú‚îÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ (MD5)
   ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—É—Ç–∏: downloaded_files[(chat_id, msg_id)] = path

2. process_messages() –¥–ª—è –ø–∞–∫–µ—Ç–∞
   ‚îú‚îÄ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å —Å–µ–º–∞—Ñ–æ—Ä–æ–º
   ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—Ç —Å–ø–∏—Å–∫–∞ message_ids

3. save_batch() - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
   ‚îÇ
   ‚îú‚îÄ –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:
   ‚îÇ  ‚îî‚îÄ save_message()
   ‚îÇ     ‚îî‚îÄ _save_html_message()
   ‚îÇ        ‚îî‚îÄ append —Å—Ç—Ä–æ–∫—É –≤ JSONL —Ñ–∞–π–ª ‚úçÔ∏è
   ‚îÇ
   ‚îî‚îÄ _generate_index_html()
      ‚îÇ
      ‚îú‚îÄ –î–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞:
      ‚îÇ  ‚îî‚îÄ _generate_chat_html()
      ‚îÇ     ‚îú‚îÄ –ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤–µ—Å—å JSONL üìñ
      ‚îÇ     ‚îú‚îÄ –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON —Å—Ç—Ä–æ–∫–∏
      ‚îÇ     ‚îú‚îÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å HTML –∏–∑ —à–∞–±–ª–æ–Ω–∞ üé®
      ‚îÇ     ‚îî‚îÄ –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å .html —Ñ–∞–π–ª ‚úÖ
      ‚îÇ
      ‚îî‚îÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å index.html ‚úÖ
         ‚îî‚îÄ –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
```

### –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

```yaml
# config.yaml
download_settings:
  pagination_limit: 100  # HTML –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
```

| –ó–Ω–∞—á–µ–Ω–∏–µ | –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è | –†–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ | –°–∫–æ—Ä–æ—Å—Ç—å |
|----------|-------------------|-------------|----------|
| 50       | –ö–∞–∂–¥—ã–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π | –ù–∏–∑–∫–∏–π | –ú–µ–¥–ª–µ–Ω–Ω–æ |
| 100      | –ö–∞–∂–¥—ã–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π | –°—Ä–µ–¥–Ω–∏–π | –û–ø—Ç–∏–º–∞–ª—å–Ω–æ ‚≠ê |
| 500      | –ö–∞–∂–¥—ã–µ 500 —Å–æ–æ–±—â–µ–Ω–∏–π | –í—ã—Å–æ–∫–∏–π | –ë—ã—Å—Ç—Ä–æ |

## –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–æ–±–ª–µ–º–∞ –∫–æ–ª–ª–∏–∑–∏–π message_id

**–°–∏—Ç—É–∞—Ü–∏—è:**
```python
# Message ID —É–Ω–∏–∫–∞–ª—å–Ω—ã —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —á–∞—Ç–∞!
–ß–∞—Ç A: —Å–æ–æ–±—â–µ–Ω–∏—è —Å ID 1, 2, 3, ..., 10000
–ß–∞—Ç B: —Å–æ–æ–±—â–µ–Ω–∏—è —Å ID 1, 2, 3, ..., 15000  # –°–æ–≤–ø–∞–¥–∞—é—Ç!
```

**–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
```python
# ‚ùå –ö–û–õ–õ–ò–ó–ò–Ø: ID=1 –∏–∑ —á–∞—Ç–∞ B –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç ID=1 –∏–∑ —á–∞—Ç–∞ A
downloaded_files[1] = "/path/video_from_chat_A.mp4"
downloaded_files[1] = "/path/photo_from_chat_B.jpg"  # –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞–ª!
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
```python
# ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä—Ç–µ–∂ (chat_id, message_id)
downloaded_files[(-1001234567890, 1)] = "/path/video_from_chat_A.mp4"
downloaded_files[(-1009876543210, 1)] = "/path/photo_from_chat_B.jpg"
```

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞

```python
# –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
def process_messages(self, messages, ...):
    # ...
    chat_id = messages[0].chat.id

    # –°–æ–∑–¥–∞—Ç—å —Å–ª–æ–≤–∞—Ä—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
    chat_files = {
        msg_id: path
        for (cid, msg_id), path in self.downloaded_files.items()
        if cid == chat_id  # ‚Üê –§–∏–ª—å—Ç—Ä –ø–æ chat_id
    }

    # –ü–µ—Ä–µ–¥–∞—Ç—å –≤ save_batch
    self.history_manager.save_batch(
        messages, chat_id, chat_title, chat_files
    )
```

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

### –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∞—Ç–æ–≤ —Å–ª–æ–≤–∞—Ä—å `downloaded_files` —Ä–∞—Å—Ç—ë—Ç:

```python
# –ó–∞–≥—Ä—É–∑–∫–∞ 3 —á–∞—Ç–æ–≤ –ø–æ 10,000 —Å–æ–æ–±—â–µ–Ω–∏–π

–ü–æ—Å–ª–µ —á–∞—Ç–∞ A: 10,000 –∑–∞–ø–∏—Å–µ–π  ‚Üí  ~500 KB
–ü–æ—Å–ª–µ —á–∞—Ç–∞ B: 20,000 –∑–∞–ø–∏—Å–µ–π  ‚Üí ~1.0 MB  # A + B
–ü–æ—Å–ª–µ —á–∞—Ç–∞ C: 30,000 –∑–∞–ø–∏—Å–µ–π  ‚Üí ~1.5 MB  # A + B + C
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–∏–Ω–µ–π–Ω—ã–π —Ä–æ—Å—Ç –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏!

### –†–µ—à–µ–Ω–∏–µ: –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞

```python
# media_downloader.py: begin_import_chat()

async def begin_import_chat(self, client, chat_id, ...):
    # ... –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞ ...

    # –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥
    self.update_config(chat_id)

    # –û—á–∏—Å—Ç–∏—Ç—å downloaded_files –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
    keys_to_remove = [
        key for key in self.downloaded_files.keys()
        if key[0] == chat_id
    ]
    for key in keys_to_remove:
        del self.downloaded_files[key]

    # –ü–∞–º—è—Ç—å –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞! üßπ
```

### –ú–µ—Ç—Ä–∏–∫–∏

**–†–∞–∑–º–µ—Ä –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏:**
```
key = (chat_id, message_id)  # 2 √ó int64 = 16 –±–∞–π—Ç
value = "/media/.../file.mp4"  # —Å—Ç—Ä–æ–∫–∞ ~50 –±–∞–π—Ç
overhead = dict overhead       # ~20 –±–∞–π—Ç
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò—Ç–æ–≥–æ: ~86 –±–∞–π—Ç –Ω–∞ –∑–∞–ø–∏—Å—å
```

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è:**

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ß–∞—Ç–æ–≤ | –°–æ–æ–±—â–µ–Ω–∏–π | –ó–∞–ø–∏—Å–µ–π | –ü–∞–º—è—Ç—å |
|----------|-------|-----------|---------|---------|
| –ë–µ–∑ –æ—á–∏—Å—Ç–∫–∏ | 25 | 10,000 | 250,000 | ~30 MB ‚ùå |
| –° –æ—á–∏—Å—Ç–∫–æ–π (max) | 25 | 15,000 | 15,000 | ~2 MB ‚úÖ |

**–≠–∫–æ–Ω–æ–º–∏—è: 93%** üéâ

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏

```python
# –°–µ–º–∞—Ñ–æ—Ä –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫
max_parallel = self.config.get("download_settings", {}).get(
    "max_parallel_downloads", 5
)
semaphore = asyncio.Semaphore(max_parallel)

# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–∫–µ—Ç–∞
async def download_with_semaphore(message):
    async with semaphore:
        return await self.download_media(...)

message_ids = await asyncio.gather(
    *[download_with_semaphore(msg) for msg in messages]
)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- –ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ç—å
- –ó–∞—â–∏—Ç–∞ –æ—Ç rate limits

### –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ MD5 —Ö–µ—à–µ–π

```python
_hash_cache: Dict[str, str] = {}

def _get_file_hash(file_path: str) -> str:
    if file_path in _hash_cache:
        return _hash_cache[file_path]  # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

    with open(file_path, "rb") as f:
        file_hash = md5(f.read()).hexdigest()
    _hash_cache[file_path] = file_hash
    return file_hash
```

**–£—Å–∫–æ—Ä–µ–Ω–∏–µ:**
- –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤: —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ + MD5
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤: –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –∏–∑ –∫–µ—à–∞

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è I/O

**Async I/O —Å Telethon:**
```python
# –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ
await client.download_media(message, file=file_name)
await client.get_messages(chat_id, ids=message.id)
```

**–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏:**
```python
# JSONL: –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –ø–∞–∫–µ—Ç
with open(jsonl_file, "a") as f:
    for message in messages:
        f.write(json.dumps(message_data) + "\n")
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```gitignore
# .gitignore
config.yaml           # –í–∞—à–∏ API –∫–ª—é—á–∏
*.session            # Telegram —Å–µ—Å—Å–∏—è
```

**–í–∞–∂–Ω–æ:**
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—å `config.yaml`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `config.yaml.example` –∫–∞–∫ —à–∞–±–ª–æ–Ω
- –•—Ä–∞–Ω–∏—Ç—å API –∫–ª—é—á–∏ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—É—Ç–µ–π

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
if not os.path.exists(file_path):
    return file_path

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ
os.makedirs(download_directory, exist_ok=True)
```

### –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –∏–º—ë–Ω —Ñ–∞–π–ª–æ–≤

```python
def _sanitize_filename(self, filename: str) -> str:
    """–û—á–∏—Å—Ç–∫–∞ –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è Windows."""
    replacements = {
        ':': '-', '<': '_', '>': '_', '"': "'",
        '/': '_', '\\': '_', '|': '_', '?': '_', '*': '_',
    }
    for char, replacement in replacements.items():
        filename = filename.replace(char, replacement)
    return filename
```

## –î–∏–∞–≥—Ä–∞–º–º—ã

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏

```mermaid
sequenceDiagram
    participant U as User
    participant M as Main
    participant D as DownloadManager
    participant H as HistoryManager
    participant T as Telegram API

    U->>M: python media_downloader.py
    M->>T: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    M->>U: –í—ã–±–æ—Ä —á–∞—Ç–æ–≤
    U->>M: –ß–∞—Ç—ã [A, B, C]

    loop –î–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞
        M->>D: begin_import_chat(chat_id)

        loop –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞–∫–µ—Ç–∞ (100 —Å–æ–æ–±—â–µ–Ω–∏–π)
            D->>T: –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
            T->>D: messages[]

            par –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
                D->>T: download_media(msg1)
                D->>T: download_media(msg2)
                D->>T: download_media(msg3)
            end

            D->>D: downloaded_files[(chat,id)]=path
            D->>H: save_batch(messages, files)
            H->>H: append ‚Üí JSONL
            H->>H: —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è HTML
        end

        D->>D: –û—á–∏—Å—Ç–∫–∞ downloaded_files[chat]
    end

    M->>T: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
    M->>U: –ì–æ—Ç–æ–≤–æ!
```

---

**–î–æ–∫—É–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω:** 2025-01-02
**–í–µ—Ä—Å–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:** 1.0
