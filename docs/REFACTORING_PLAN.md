# План рефакторинга Telegram Media Downloader

Этот документ описывает план работ по улучшению архитектуры, качества кода и поддерживаемости проекта.

## Этап 1: Внедрение Pydantic для конфигурации
**Цель:** Заменить ручную валидацию конфигурации на строгую схему с использованием `pydantic`.
**Задачи:**
1.  Добавить `pydantic` в зависимости (`requirements.txt`).
2.  Создать модели данных для конфигурации (например, в `utils/schemas.py` или `utils/config_schema.py`).
    *   `ProxyConfig`
    *   `DownloadSettings`
    *   `AppConfig`
3.  Обновить `ConfigManager` в `utils/config.py` для использования этих моделей.
4.  Убедиться, что ошибки конфигурации выводятся пользователю понятно.
5.  Обновить тесты конфигурации.

## Этап 2: Шаблонизация с Jinja2
**Цель:** Вынести генерацию HTML из кода Python в отдельные шаблоны для безопасности и удобства поддержки.
**Задачи:**
1.  Добавить `jinja2` в зависимости.
2.  Создать директорию `templates/` и перенести туда HTML-структуру из `utils/history.py`.
3.  Создать шаблон `chat_history.html`.
4.  Обновить `utils/history.py` (или новый класс `HtmlSaver`) для использования Jinja2 Environment для рендеринга.
5.  Проверить корректность экранирования данных.

## Этап 3: Декомпозиция `media_downloader.py`
**Цель:** Разгрузить основной файл, разделив CLI, управление сессией и логику скачивания.
**Задачи:**
1.  Выделить класс `SessionManager` (или `TelegramService`), отвечающий только за инициализацию клиента Telethon и соединение.
2.  Выделить логику скачивания (очередь, обработка типов файлов) в `DownloadService` или расширить существующие методы, убрав зависимость от глобального состояния.
3.  Оставить в `media_downloader.py` только разбор аргументов (`argparse`) и высокоуровневый запуск процессов.

## Этап 4: Рефакторинг `MessageHistory`
**Цель:** Разделить логику сохранения разных форматов (JSON, HTML, TXT).
**Задачи:**
1.  Создать абстрактный базовый класс `HistorySaver` с методом `save_message`.
2.  Реализовать подклассы:
    *   `JsonHistorySaver`
    *   `HtmlHistorySaver`
    *   `TxtHistorySaver`
3.  Использовать фабрику или простой выбор класса в зависимости от конфига.
4.  Обновить вызовы в `media_downloader.py` (или `DownloadService`).

## Этап 5: Обновление управления зависимостями
**Цель:** Упростить `setup.py` и файлы requirements.
**Задачи:**
1.  Создать `pyproject.toml`.
2.  Перенести зависимости.
3.  Настроить инструменты разработки (black, isort, mypy) в `pyproject.toml`.

## Текущий статус
- [x] Этап 1: Pydantic
- [x] Этап 2: Jinja2
- [x] Этап 3: Декомпозиция
- [x] Этап 4: History Refactoring
- [x] Этап 5: Dependencies
