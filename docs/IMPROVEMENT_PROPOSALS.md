# –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é Telegram Media Downloader

## üìä –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –ø—Ä–æ–µ–∫—Ç–∞

1. **–û—Ç–ª–∏—á–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**
   - –ß–∏—Å—Ç–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –º–æ–¥—É–ª–∏ (`core`, `utils`)
   - –•–æ—Ä–æ—à–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ (27 —Ç–µ—Å—Ç–æ–≤)
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

2. **Rich Feature Set**
   - TUI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏
   - –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (JSON/TXT/HTML)
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –∏ –∞—Ä—Ö–∏–≤–æ–≤
   - –ü—Ä–æ–∫—Å–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞
   - –§–∏–ª—å—Ç—Ä—ã (–¥–∞—Ç–∞, –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å, —Ñ–æ—Ä–º–∞—Ç)

3. **User Experience**
   - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä —á–∞—Ç–æ–≤
   - –†—É—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –£—Ç–∏–ª–∏—Ç—ã (export, cleanup, rebuild)

### ‚ö†Ô∏è –û–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

#### 1. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω–¥–∏–∫–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤
- –ù–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —á–∞—Ç–æ–≤ (100k+ —Å–æ–æ–±—â–µ–Ω–∏–π)
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–∂–∞—Ç–∏–µ –∞—Ä—Ö–∏–≤–æ–≤

#### 2. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- –ù–µ—Ç –ø–æ–∏—Å–∫–∞ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç –≤ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã (PDF, EPUB)
- –ù–µ—Ç –±—ç–∫–∞–ø–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á

#### 3. User Experience
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç GUI (—Ç–æ–ª—å–∫–æ CLI/TUI)
- –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–æ–∫

---

## üöÄ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—è–º

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–Ω—ã–µ

#### 1.1 Resumable Downloads (–≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏)

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –æ–±—Ä—ã–≤–µ –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å—à–æ–≥–æ —Ñ–∞–π–ª–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –Ω–∞—á–∏–Ω–∞—Ç—å –∑–∞–Ω–æ–≤–æ.

**–†–µ—à–µ–Ω–∏–µ**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —á–∞—Å—Ç–∏—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏:

```python
# utils/resumable_download.py
class ResumableDownloader:
    def __init__(self, client, cache_dir=\".download_cache\"):
        self.client = client
        self.cache_dir = Path(cache_dir)
        self.cache_dir.mkdir(exist_ok=True)

    async def download_with_resume(self, message, target_path):
        \"\"\"–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.\"\"\"
        cache_file = self.cache_dir / f\"{message.id}.part\"
        offset = 0

        if cache_file.exists():
            offset = cache_file.stat().st_size
            logger.info(f\"–í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å {offset} bytes\")

        # Telethon –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç offset –¥–ª—è download_media
        await self.client.download_media(
            message,
            file=cache_file,
            offset=offset
        )

        # –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ —Ü–µ–ª–µ–≤—É—é –ø–∞–ø–∫—É
        cache_file.rename(target_path)
```

**–ö–æ–Ω—Ñ–∏–≥:**
```yaml
download_settings:
  resumable_downloads: true
  cache_directory: \".download_cache\"
  auto_cleanup_cache: true  # –û—á–∏—â–∞—Ç—å –∫—ç—à –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚è±Ô∏è –≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –æ–±—Ä—ã–≤–∞—Ö
- üíæ –≠–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞
- üîÑ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö/–Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

---

#### 1.2 Database Backend –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞**: –•—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ YAML –∏ JSONL –º–µ–¥–ª–µ–Ω–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ (100k+ —Å–æ–æ–±—â–µ–Ω–∏–π).

**–†–µ—à–µ–Ω–∏–µ**: –í—ã–±–æ—Ä database backend –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–∞—Å—à—Ç–∞–±–∞:

##### –í–∞—Ä–∏–∞–Ω—Ç A: SQLite (–¥–ª—è –º–∞–ª—ã—Ö/—Å—Ä–µ–¥–Ω–∏—Ö –æ–±—ä—ë–º–æ–≤ –¥–æ 1M —Å–æ–æ–±—â–µ–Ω–∏–π)

```python
# utils/metadata_db.py
import sqlite3
from datetime import datetime
from typing import Optional, List, Dict

class SQLiteMetadataDB:
    def __init__(self, db_path="metadata.db"):
        self.conn = sqlite3.connect(db_path)
        self._init_schema()

    def _init_schema(self):
        self.conn.execute('''
            CREATE TABLE IF NOT EXISTS messages (
                chat_id INTEGER,
                message_id INTEGER PRIMARY KEY,
                date TIMESTAMP,
                text TEXT,
                media_type TEXT,
                file_path TEXT,
                file_size INTEGER,
                downloaded BOOLEAN DEFAULT 0,
                download_date TIMESTAMP,
                sender_id INTEGER
            )
        ''')

        self.conn.execute('''
            CREATE TABLE IF NOT EXISTS chats (
                chat_id INTEGER PRIMARY KEY,
                title TEXT,
                last_sync TIMESTAMP,
                message_count INTEGER,
                total_size INTEGER
            )
        ''')

        # –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        self.conn.execute('CREATE INDEX IF NOT EXISTS idx_chat_messages ON messages(chat_id)')
        self.conn.execute('CREATE INDEX IF NOT EXISTS idx_message_date ON messages(date)')
        self.conn.execute('CREATE INDEX IF NOT EXISTS idx_downloaded ON messages(downloaded)')

        # Full-text search –∏–Ω–¥–µ–∫—Å
        self.conn.execute('''
            CREATE VIRTUAL TABLE IF NOT EXISTS messages_fts
            USING fts5(message_id, text, content=messages)
        ''')
        self.conn.commit()

    def search_messages(self, query: str, chat_id: Optional[int] = None) -> List[Dict]:
        """Full-text search –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º."""
        if chat_id:
            sql = '''
                SELECT m.* FROM messages m
                JOIN messages_fts fts ON m.message_id = fts.message_id
                WHERE messages_fts MATCH ? AND m.chat_id = ?
            '''
            cursor = self.conn.execute(sql, (query, chat_id))
        else:
            sql = '''
                SELECT m.* FROM messages m
                JOIN messages_fts fts ON m.message_id = fts.message_id
                WHERE messages_fts MATCH ?
            '''
            cursor = self.conn.execute(sql, (query,))

        return [dict(zip([col[0] for col in cursor.description], row))
                for row in cursor.fetchall()]
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ SQLite:**
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ FTS5 –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
- ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤ (–¥–æ 1M —Å–æ–æ–±—â–µ–Ω–∏–π)
- ‚úÖ Zero-configuration

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚ùå –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –ø—Ä–∏ 1M+ –∑–∞–ø–∏—Å–µ–π
- ‚ùå –ù–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- ‚ùå –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ä–∞–∑–º–µ—Ä—É –ë–î (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã)

---

##### –í–∞—Ä–∏–∞–Ω—Ç B: PostgreSQL (–¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ 1M-100M —Å–æ–æ–±—â–µ–Ω–∏–π)

```python
# utils/postgres_db.py
import asyncpg
from datetime import datetime
from typing import Optional, List, Dict

class PostgreSQLMetadataDB:
    def __init__(self, dsn="postgresql://user:password@localhost/telegram_media"):
        self.dsn = dsn
        self.pool = None

    async def connect(self):
        """–°–æ–∑–¥–∞—Ç—å –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π."""
        self.pool = await asyncpg.create_pool(
            self.dsn,
            min_size=5,
            max_size=20
        )
        await self._init_schema()

    async def _init_schema(self):
        async with self.pool.acquire() as conn:
            await conn.execute('''
                CREATE TABLE IF NOT EXISTS messages (
                    chat_id BIGINT,
                    message_id BIGINT PRIMARY KEY,
                    date TIMESTAMP WITH TIME ZONE,
                    text TEXT,
                    media_type VARCHAR(50),
                    file_path TEXT,
                    file_size BIGINT,
                    downloaded BOOLEAN DEFAULT FALSE,
                    download_date TIMESTAMP WITH TIME ZONE,
                    sender_id BIGINT
                )
            ''')

            await conn.execute('''
                CREATE TABLE IF NOT EXISTS chats (
                    chat_id BIGINT PRIMARY KEY,
                    title TEXT,
                    last_sync TIMESTAMP WITH TIME ZONE,
                    message_count INTEGER,
                    total_size BIGINT
                )
            ''')

            # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
            await conn.execute('CREATE INDEX IF NOT EXISTS idx_chat_messages ON messages(chat_id, date DESC)')
            await conn.execute('CREATE INDEX IF NOT EXISTS idx_downloaded ON messages(downloaded) WHERE downloaded = FALSE')

            # Full-text search —Å —Ä—É—Å—Å–∫–∏–º —è–∑—ã–∫–æ–º
            await conn.execute('''
                CREATE INDEX IF NOT EXISTS idx_messages_text_search
                ON messages USING gin(to_tsvector('russian', text))
            ''')

    async def search_messages(self, query: str, chat_id: Optional[int] = None) -> List[Dict]:
        """Full-text search —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞."""
        async with self.pool.acquire() as conn:
            if chat_id:
                rows = await conn.fetch('''
                    SELECT * FROM messages
                    WHERE to_tsvector('russian', text) @@ plainto_tsquery('russian', $1)
                    AND chat_id = $2
                    ORDER BY date DESC
                    LIMIT 1000
                ''', query, chat_id)
            else:
                rows = await conn.fetch('''
                    SELECT * FROM messages
                    WHERE to_tsvector('russian', text) @@ plainto_tsquery('russian', $1)
                    ORDER BY date DESC
                    LIMIT 1000
                ''', query)

            return [dict(row) for row in rows]

    async def get_chat_statistics(self, chat_id: int) -> Dict:
        """–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —á–∞—Ç—É."""
        async with self.pool.acquire() as conn:
            row = await conn.fetchrow('''
                SELECT
                    COUNT(*) as total_messages,
                    COUNT(*) FILTER (WHERE downloaded) as downloaded_count,
                    COALESCE(SUM(file_size), 0) as total_size,
                    MIN(date) as first_message,
                    MAX(date) as last_message
                FROM messages
                WHERE chat_id = $1
            ''', chat_id)

            return dict(row)

    async def bulk_insert_messages(self, messages: List[Dict]):
        """–ú–∞—Å—Å–æ–≤–∞—è –≤—Å—Ç–∞–≤–∫–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏."""
        async with self.pool.acquire() as conn:
            await conn.copy_records_to_table(
                'messages',
                records=messages,
                columns=['chat_id', 'message_id', 'date', 'text', 'media_type', 'sender_id']
            )
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ PostgreSQL:**
- ‚úÖ **–û—Ç–ª–∏—á–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –¥–ª—è 1M-100M –∑–∞–ø–∏—Å–µ–π
- ‚úÖ **Full-text search** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
- ‚úÖ **JSONB** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä
- ‚úÖ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** –∏ –∑–∞–ø–∏—Å—å
- ‚úÖ **–†–µ–ø–ª–∏–∫–∞—Ü–∏—è** –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
- ‚úÖ **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** —Ç–∞–±–ª–∏—Ü –ø–æ chat_id –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå –¢—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
- ‚ùå –°–ª–æ–∂–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

---

##### –í–∞—Ä–∏–∞–Ω—Ç C: ClickHouse (–¥–ª—è –æ–≥—Ä–æ–º–Ω—ã—Ö –æ–±—ä—ë–º–æ–≤ 100M+ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)

```python
# utils/clickhouse_db.py
from clickhouse_driver import Client

class ClickHouseMetadataDB:
    def __init__(self, host='localhost', port=9000):
        self.client = Client(host=host, port=port)
        self._init_schema()

    def _init_schema(self):
        self.client.execute('''
            CREATE TABLE IF NOT EXISTS messages (
                chat_id Int64,
                message_id Int64,
                date DateTime,
                text String,
                media_type LowCardinality(String),
                file_path String,
                file_size UInt64,
                downloaded UInt8,
                download_date DateTime,
                sender_id Int64,
                INDEX idx_text text TYPE tokenbf_v1(10240, 3, 0) GRANULARITY 1
            ) ENGINE = MergeTree()
            PARTITION BY toYYYYMM(date)
            ORDER BY (chat_id, date, message_id)
        ''')

        self.client.execute('''
            CREATE TABLE IF NOT EXISTS chats (
                chat_id Int64,
                title String,
                last_sync DateTime,
                message_count UInt32,
                total_size UInt64
            ) ENGINE = ReplacingMergeTree()
            ORDER BY chat_id
        ''')

    def search_messages(self, query: str, chat_id=None):
        """–ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫."""
        if chat_id:
            return self.client.execute('''
                SELECT * FROM messages
                WHERE hasToken(text, %(query)s) AND chat_id = %(chat_id)s
                ORDER BY date DESC
                LIMIT 1000
            ''', {'query': query, 'chat_id': chat_id})
        else:
            return self.client.execute('''
                SELECT * FROM messages
                WHERE hasToken(text, %(query)s)
                ORDER BY date DESC
                LIMIT 1000
            ''', {'query': query})

    def get_analytics(self, chat_id: int):
        """–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —á–∞—Ç—É."""
        return self.client.execute('''
            SELECT
                toStartOfDay(date) as day,
                count() as messages_count,
                uniqExact(sender_id) as unique_senders,
                sum(file_size) as total_size,
                countIf(media_type != '') as media_count
            FROM messages
            WHERE chat_id = %(chat_id)s
            GROUP BY day
            ORDER BY day DESC
            LIMIT 365
        ''', {'chat_id': chat_id})
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ ClickHouse:**
- ‚úÖ **–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **–ö–æ–ª–æ–Ω–æ—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** ‚Äî –º–µ–Ω—å—à–µ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** –ø–æ –¥–∞—Ç–∞–º
- ‚úÖ **–°–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö** (–≤ 5-10 —Ä–∞–∑ –º–µ–Ω—å—à–µ –º–µ—Å—Ç–∞ —á–µ–º PostgreSQL)
- ‚úÖ **–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤** (–º–∏–ª–ª–∏–∞—Ä–¥—ã –∑–∞–ø–∏—Å–µ–π)

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå **–ù–µ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**
- ‚ùå –°–ª–æ–∂–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- ‚ùå –¢—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ RAM

---

##### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–±–æ—Ä—É

| –û–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | –ü—Ä–∏—á–∏–Ω–∞ |
|--------------|-------------|---------|
| < 1M —Å–æ–æ–±—â–µ–Ω–∏–π | **SQLite** | –ü—Ä–æ—Å—Ç–æ—Ç–∞, –Ω–µ –Ω—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä |
| 1M - 100M —Å–æ–æ–±—â–µ–Ω–∏–π | **PostgreSQL** | –ë–∞–ª–∞–Ω—Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ |
| > 100M —Å–æ–æ–±—â–µ–Ω–∏–π | **ClickHouse** | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ |

**–ö–æ–Ω—Ñ–∏–≥:**
```yaml
download_settings:
  use_database: true
  database_backend: postgresql  # sqlite, postgresql, clickhouse

  # SQLite
  sqlite:
    database_path: "metadata.db"

  # PostgreSQL
  postgresql:
    host: localhost
    port: 5432
    database: telegram_media
    username: user
    password: password
    pool_size: 10

  # ClickHouse
  clickhouse:
    host: localhost
    port: 9000
    database: default

  keep_jsonl_backup: true  # –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ JSONL –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–∞–¥ —Ç–µ–∫—É—â–∏–º —Ä–µ—à–µ–Ω–∏–µ–º:**
- üöÄ **10-100x —É—Å–∫–æ—Ä–µ–Ω–∏–µ** –¥–ª—è –ø–æ–∏—Å–∫–∞
- üìä **–ú–æ—â–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞** (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –≥—Ä–∞—Ñ–∏–∫–∏)
- üîç **Full-text search** —Å —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- üìà **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** –¥–æ –º–∏–ª–ª–∏–∞—Ä–¥–æ–≤ –∑–∞–ø–∏—Å–µ–π

```python
# utils/metadata_db.py
import sqlite3
from datetime import datetime
from typing import Optional, List, Dict

class MetadataDB:
    def __init__(self, db_path=\"metadata.db\"):
        self.conn = sqlite3.connect(db_path)
        self._init_schema()

    def _init_schema(self):
        self.conn.execute('''
            CREATE TABLE IF NOT EXISTS messages (
                chat_id INTEGER,
                message_id INTEGER PRIMARY KEY,
                date TIMESTAMP,
                text TEXT,
                media_type TEXT,
                file_path TEXT,
                file_size INTEGER,
                downloaded BOOLEAN DEFAULT 0,
                download_date TIMESTAMP,
                sender_id INTEGER
            )
        ''')

        self.conn.execute('''
            CREATE TABLE IF NOT EXISTS chats (
                chat_id INTEGER PRIMARY KEY,
                title TEXT,
                last_sync TIMESTAMP,
                message_count INTEGER,
                total_size INTEGER
            )
        ''')

        self.conn.execute('CREATE INDEX IF NOT EXISTS idx_chat_messages ON messages(chat_id)')
        self.conn.commit()

    def add_message(self, chat_id: int, message_data: Dict):
        \"\"\"–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–∞–∑—É.\"\"\"
        self.conn.execute('''
            INSERT OR REPLACE INTO messages
            (chat_id, message_id, date, text, media_type, sender_id)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (
            chat_id,
            message_data['id'],
            message_data['date'],
            message_data.get('text'),
            message_data.get('media_type'),
            message_data.get('sender_id')
        ))
        self.conn.commit()

    def mark_downloaded(self, message_id: int, file_path: str, file_size: int):
        \"\"\"–û—Ç–º–µ—Ç–∏—Ç—å —Ñ–∞–π–ª –∫–∞–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π.\"\"\"
        self.conn.execute('''
            UPDATE messages
            SET downloaded = 1, file_path = ?, file_size = ?, download_date = ?
            WHERE message_id = ?
        ''', (file_path, file_size, datetime.now(), message_id))
        self.conn.commit()

    def search_messages(self, query: str, chat_id: Optional[int] = None) -> List[Dict]:
        \"\"\"–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–π.\"\"\"
        sql = 'SELECT * FROM messages WHERE text LIKE ?'
        params = [f'%{query}%']

        if chat_id:
            sql += ' AND chat_id = ?'
            params.append(chat_id)

        cursor = self.conn.execute(sql, params)
        return [dict(zip([col[0] for col in cursor.description], row))
                for row in cursor.fetchall()]

    def get_chat_statistics(self, chat_id: int) -> Dict:
        \"\"\"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —á–∞—Ç—É.\"\"\"
        cursor = self.conn.execute('''
            SELECT
                COUNT(*) as total_messages,
                SUM(CASE WHEN downloaded THEN 1 ELSE 0 END) as downloaded_count,
                SUM(file_size) as total_size
            FROM messages
            WHERE chat_id = ?
        ''', (chat_id,))

        row = cursor.fetchone()
        return {
            'total_messages': row[0],
            'downloaded_count': row[1],
            'total_size': row[2] or 0
        }
```

**–ö–æ–Ω—Ñ–∏–≥:**
```yaml
download_settings:
  use_database: true
  database_path: \"metadata.db\"
  keep_jsonl_backup: true  # –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ JSONL –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üöÄ **–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫** –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ (SQL –∏–Ω–¥–µ–∫—Å—ã)
- üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** –ø–æ —á–∞—Ç–∞–º
- üîç **Full-text search** –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º
- üìà **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** –¥–ª—è –º–∏–ª–ª–∏–æ–Ω–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π

---

#### 1.3 –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∞—Ç–æ–≤ –Ω–µ—Ç –æ–±—â–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.

**–†–µ—à–µ–Ω–∏–µ**: Rich progress —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏:

```python
# core/downloader.py
from rich.progress import Progress, SpinnerColumn, BarColumn, TextColumn, TimeElapsedColumn

class DownloadManager:
    async def begin_import_chats(self, client, chat_queue: List[Tuple[int, str]], pagination_limit: int):
        \"\"\"–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∞—Ç–æ–≤ —Å –æ–±—â–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.\"\"\"

        with Progress(
            SpinnerColumn(),
            TextColumn(\"[progress.description]{task.description}\"),
            BarColumn(),
            TextColumn(\"[progress.percentage]{task.percentage:>3.0f}%\"),
            TimeElapsedColumn(),
        ) as progress:

            # –û–±—â–∞—è –∑–∞–¥–∞—á–∞
            overall_task = progress.add_task(
                f\"[cyan]–û–±—Ä–∞–±–æ—Ç–∫–∞ {len(chat_queue)} —á–∞—Ç–æ–≤\",
                total=len(chat_queue)
            )

            for chat_id, chat_title in chat_queue:
                # –ó–∞–¥–∞—á–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
                chat_task = progress.add_task(
                    f\"[green]{chat_title or chat_id}\",
                    total=None
                )

                try:
                    await self.begin_import_chat(
                        client, chat_id, chat_title, pagination_limit,
                        progress=progress, task_id=chat_task
                    )
                except Exception as e:
                    logger.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ {chat_title}: {e}\")
                finally:
                    progress.update(chat_task, visible=False)
                    progress.advance(overall_task)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üëÅÔ∏è –í–∏–¥–∏–º–æ—Å—Ç—å –æ–±—â–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- ‚è±Ô∏è –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- üìä –°—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

#### 2.1 Web Dashboard (–≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)

**–†–µ—à–µ–Ω–∏–µ**: FastAPI + Vue.js –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```python
# web_dashboard.py
from fastapi import FastAPI, WebSocket
from fastapi.staticfiles import StaticFiles
from fastapi.responses import HTMLResponse
import asyncio

app = FastAPI()

class DownloadDashboard:
    def __init__(self):
        self.active_downloads = {}
        self.stats = {}

@app.get(\"/\")
async def dashboard():
    return HTMLResponse(open(\"dashboard/index.html\").read())

@app.get(\"/api/chats\")
async def get_chats():
    \"\"\"–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π.\"\"\"
    return {
        \"chats\": [
            {
                \"id\": chat_id,
                \"title\": title,
                \"messages\": count,
                \"downloaded\": downloaded,
                \"size\": size
            }
            for chat_id, (title, count, downloaded, size) in chats_data.items()
        ]
    }

@app.websocket(\"/ws/progress\")
async def websocket_progress(websocket: WebSocket):
    \"\"\"WebSocket –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.\"\"\"
    await websocket.accept()

    while True:
        # –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        progress_data = get_current_progress()
        await websocket.send_json(progress_data)
        await asyncio.sleep(1)

@app.post(\"/api/download/start\")
async def start_download(chat_id: int):
    \"\"\"–ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —á–∞—Ç–∞.\"\"\"
    # –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∑–∞–≥—Ä—É–∑–∫–∏
    task = asyncio.create_task(download_chat(chat_id))
    return {\"status\": \"started\", \"task_id\": id(task)}

@app.post(\"/api/download/pause\")
async def pause_download(chat_id: int):
    \"\"\"–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É.\"\"\"
    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—É–∑—ã
    pass

# –ó–∞–ø—É—Å–∫: uvicorn web_dashboard:app --reload
```

**JavaScript (dashboard/index.html):**
```html
<script src=\"https://cdn.jsdelivr.net/npm/vue@3\"></script>
<script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      chats: [],
      progress: {},
      ws: null
    }
  },
  mounted() {
    this.fetchChats();
    this.connectWebSocket();
  },
  methods: {
    async fetchChats() {
      const response = await fetch('/api/chats');
      this.chats = await response.json();
    },
    connectWebSocket() {
      this.ws = new WebSocket('ws://localhost:8000/ws/progress');
      this.ws.onmessage = (event) => {
        this.progress = JSON.parse(event.data);
      };
    },
    async startDownload(chatId) {
      await fetch('/api/download/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({chat_id: chatId})
      });
    }
  }
}).mount('#app');
</script>
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- üìä –î–∞—à–±–æ—Ä–¥ —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- üî¥ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∞–º–∏ (—Å—Ç–∞—Ä—Ç/–ø–∞—É–∑–∞/—Å—Ç–æ–ø)
- üìà –ì—Ä–∞—Ñ–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–µ—Å—Ç–∞
- üîç –ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏
- üì± –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

---

#### 2.2 –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–≥—Ä—É–∑–æ–∫

**–†–µ—à–µ–Ω–∏–µ**: Cron-–ø–æ–¥–æ–±–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫:

```python
# utils/scheduler.py
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from datetime import time

class DownloadScheduler:
    def __init__(self, config_manager, download_manager):
        self.config = config_manager
        self.downloader = download_manager
        self.scheduler = AsyncIOScheduler()

    def setup_schedules(self):
        \"\"\"–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞.\"\"\"
        schedules = self.config.config.get('schedules', [])

        for schedule in schedules:
            if schedule['type'] == 'daily':
                self.scheduler.add_job(
                    self.run_download,
                    'cron',
                    hour=schedule['hour'],
                    minute=schedule['minute'],
                    args=[schedule['chats']]
                )
            elif schedule['type'] == 'interval':
                self.scheduler.add_job(
                    self.run_download,
                    'interval',
                    hours=schedule['hours'],
                    args=[schedule['chats']]
                )

    async def run_download(self, chat_ids):
        \"\"\"–ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.\"\"\"
        logger.info(f\"–ó–∞–ø—É—Å–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏: {chat_ids}\")
        # –ó–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏
        await self.downloader.download_chats(chat_ids)

    def start(self):
        self.scheduler.start()
```

**–ö–æ–Ω—Ñ–∏–≥:**
```yaml
schedules:
  - type: daily
    hour: 2
    minute: 0
    chats: [123456789, 987654321]
    description: \"–ù–æ—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤\"

  - type: interval
    hours: 6
    chats: [111111111]
    description: \"–ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\"
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚è∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
- üåô –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –Ω–æ—á–Ω–æ–µ –≤—Ä–µ–º—è
- üîÑ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

---

#### 2.3 –≠–∫—Å–ø–æ—Ä—Ç –≤ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

**–†–µ—à–µ–Ω–∏–µ**: –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –≤ PDF, EPUB, Markdown:

```python
# utils/exporters.py

class PDFExporter:
    def export_to_pdf(self, chat_id: int, output_path: str):
        \"\"\"–≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –≤ PDF —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º.\"\"\"
        from reportlab.lib.pagesizes import A4
        from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer
        from reportlab.lib.styles import getSampleStyleSheet

        doc = SimpleDocTemplate(output_path, pagesize=A4)
        styles = getSampleStyleSheet()
        story = []

        messages = self._load_messages(chat_id)

        for msg in messages:
            # –î–æ–±–∞–≤–∏—Ç—å –¥–∞—Ç—É –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
            header = Paragraph(
                f\"{msg['date']} - {msg['sender']}\",
                styles['Heading3']
            )
            story.append(header)

            # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            if msg['text']:
                text = Paragraph(msg['text'], styles['Normal'])
                story.append(text)

            # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ–¥–∏–∞
            if msg['media_type']:
                media = Paragraph(
                    f\"[{msg['media_type'].upper()}]: {msg['file_name']}\",
                    styles['Italic']
                )
                story.append(media)

            story.append(Spacer(1, 12))

        doc.build(story)

class MarkdownExporter:
    def export_to_markdown(self, chat_id: int, output_path: str):
        \"\"\"–≠–∫—Å–ø–æ—Ä—Ç –≤ Markdown –¥–ª—è GitHub/Obsidian.\"\"\"
        messages = self._load_messages(chat_id)

        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(f\"# Chat {chat_id}\\n\\n\")

            for msg in messages:
                f.write(f\"## {msg['date']}\\n\\n\")
                f.write(f\"**{msg['sender']}**\\n\\n\")

                if msg['text']:
                    f.write(f\"{msg['text']}\\n\\n\")

                if msg['media_type']:
                    f.write(f\"![{msg['media_type']}]({msg['file_path']})\\n\\n\")

                f.write(\"---\\n\\n\")

class EPUBExporter:
    def export_to_epub(self, chat_id: int, output_path: str):
        \"\"\"–≠–∫—Å–ø–æ—Ä—Ç –≤ EPUB –¥–ª—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –∫–Ω–∏–≥.\"\"\"
        from ebooklib import epub

        book = epub.EpubBook()
        book.set_title(f\"Telegram Chat {chat_id}\")

        messages = self._load_messages(chat_id)

        # –°–æ–∑–¥–∞—Ç—å –≥–ª–∞–≤—ã –ø–æ –¥–Ω—è–º
        chapters_by_date = {}
        for msg in messages:
            date = msg['date'].date()
            if date not in chapters_by_date:
                chapters_by_date[date] = []
            chapters_by_date[date].append(msg)

        for date, msgs in chapters_by_date.items():
            chapter = epub.EpubHtml(
                title=str(date),
                file_name=f\"chap_{date}.xhtml\"
            )

            content = '<h1>' + str(date) + '</h1>'
            for msg in msgs:
                content += f'<p><strong>{msg[\"sender\"]}</strong>: {msg[\"text\"]}</p>'

            chapter.content = content
            book.add_item(chapter)

        epub.write_epub(output_path, book)
```

**CLI:**
```bash
python export_chat.py --chat-id 123456 --format pdf --output chat.pdf
python export_chat.py --chat-id 123456 --format markdown --output chat.md
python export_chat.py --chat-id 123456 --format epub --output chat.epub
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üìÑ PDF –¥–ª—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è
- üìñ EPUB –¥–ª—è —á—Ç–µ–Ω–∏—è –Ω–∞ eReader
- üìù Markdown –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Obsidian/Notion

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: Nice-to-have

#### 3.1 –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ**: Desktop notifications –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏:

```python
# utils/notifications.py
from plyer import notification

def notify_download_complete(chat_title, files_count, total_size):
    notification.notify(
        title='–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞',
        message=f\"{chat_title}: {files_count} —Ñ–∞–π–ª–æ–≤ ({total_size} MB)\",
        app_name='Telegram Media Downloader',
        timeout=10
    )
```

**–ö–æ–Ω—Ñ–∏–≥:**
```yaml
notifications:
  enabled: true
  on_chat_complete: true
  on_all_complete: true
  sound: true
```

---

#### 3.3 Telegram Bot Interface

**–†–µ—à–µ–Ω–∏–µ**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞:

```python
# telegram_bot.py
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes

class DownloadBot:
    def __init__(self, bot_token, downloader):
        self.app = Application.builder().token(bot_token).build()
        self.downloader = downloader

    async def start_download(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        \"\"\"–°—Ç–∞—Ä—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ –±–æ—Ç: /download 123456\"\"\"
        chat_id = int(context.args[0])
        await update.message.reply_text(f\"–ó–∞–ø—É—Å–∫–∞—é –∑–∞–≥—Ä—É–∑–∫—É {chat_id}...\")

        # –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –≤ —Ñ–æ–Ω–µ
        asyncio.create_task(self.downloader.download_chat(chat_id))

    async def get_status(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        \"\"\"–°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–æ–∫: /status\"\"\"
        stats = self.downloader.get_statistics()
        await update.message.reply_text(
            f\"–ê–∫—Ç–∏–≤–Ω—ã—Ö: {stats['active']}\\n\"
            f\"–ó–∞–≤–µ—Ä—à–µ–Ω–æ: {stats['completed']}\\n\"
            f\"–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: {stats['total_files']}\"
        )
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- üì± –£–¥–∞–ª—ë–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∞–º–∏
- üìä –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤
- üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

---

#### 3.4 Cloud Storage Integration

**–†–µ—à–µ–Ω–∏–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–≥—Ä—É–∑–∫–∞ –≤ –æ–±–ª–∞–∫–æ:

```python
# utils/cloud_upload.py

class CloudUploader:
    def __init__(self, provider='dropbox'):
        self.provider = provider

    async def upload_to_dropbox(self, local_path, remote_path):
        import dropbox
        dbx = dropbox.Dropbox(os.getenv('DROPBOX_TOKEN'))

        with open(local_path, 'rb') as f:
            dbx.files_upload(f.read(), remote_path)

    async def upload_to_gdrive(self, local_path, folder_id):
        from googleapiclient.discovery import build
        # ... —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
```

**–ö–æ–Ω—Ñ–∏–≥:**
```yaml
cloud_storage:
  enabled: true
  provider: dropbox  # dropbox, gdrive, onedrive
  auto_upload: true
  upload_after_download: true
  keep_local: false  # –£–¥–∞–ª—è—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –ø–æ—Å–ª–µ –≤—ã–≥—Ä—É–∑–∫–∏
```

---

#### 3.5 Duplicate Detection (—É–ª—É—á—à–µ–Ω–Ω–∞—è)

**–†–µ—à–µ–Ω–∏–µ**: Perceptual hashing –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:

```python
# utils/deduplication.py
import imagehash
from PIL import Image

class AdvancedDeduplicator:
    def __init__(self):
        self.image_hashes = {}

    def get_image_hash(self, image_path):
        \"\"\"Perceptual hash –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø–æ—Ö–æ–∂–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.\"\"\"
        img = Image.open(image_path)
        return imagehash.average_hash(img)

    def is_duplicate(self, image_path, threshold=5):
        \"\"\"–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–º.\"\"\"
        current_hash = self.get_image_hash(image_path)

        for path, stored_hash in self.image_hashes.items():
            if current_hash - stored_hash < threshold:
                return True, path

        self.image_hashes[image_path] = current_hash
        return False, None
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üñºÔ∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Å–ª–µ–≥–∫–∞ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- üíæ –≠–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞
- üîç –ë–æ–ª–µ–µ —É–º–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

---

## üìã –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –¥–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞

### –≠—Ç–∞–ø 1: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 –Ω–µ–¥–µ–ª–∏)
1. ‚úÖ [DONE] Resumable downloads
2. ‚úÖ [DONE] –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤
3. ‚úÖ Database backend

### –≠—Ç–∞–ø 2: –í–∞–∂–Ω—ã–µ —Ñ–∏—á–∏ (2-4 –Ω–µ–¥–µ–ª–∏)
4. ‚úÖ Web Dashboard
5. ‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–≥—Ä—É–∑–æ–∫
6. ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF/EPUB/MD

### –≠—Ç–∞–ø 3: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (4-6 –Ω–µ–¥–µ–ª—å)
7. ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
8. ‚úÖ Telegram Bot Interface
9. ‚úÖ Cloud Storage Integration

---

## üéØ –í—ã–≤–æ–¥—ã

**–ü—Ä–æ–µ–∫—Ç –≤ –æ—Ç–ª–∏—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏:**
- ‚úÖ –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ –•–æ—Ä–æ—à–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
- ‚úÖ Rich feature set

**–¢–æ–ø-3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. **Database backend (ClickHouse)** ‚Äî –≤—ã–±—Ä–∞–Ω –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
2. **Web Dashboard** ‚Äî –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∏—Ç UX –∏ –ø–æ–∑–≤–æ–ª–∏—Ç —É–¥–æ–±–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ ClickHouse.
3. **Resumable Downloads** ‚Äî –ø–æ–≤—ã—Å–∏—Ç –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** 8/10
**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª:** 10/10 —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏
