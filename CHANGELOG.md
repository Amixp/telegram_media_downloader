# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Fixed
- **Исправлен баг с завышенным количеством сообщений в индексе** (`utils/history.py`)
  - В `index.html` для каждого чата отображалось неправильное (завышенное) количество сообщений
  - Причина: при обновлении манифеста к существующему `message_count` добавлялась дельта из текущего запуска, что приводило к накоплению ошибок
  - Решение: всегда пересчитывать `message_count` из JSONL файла (источник истины), так как JSONL уже содержит все сообщения, включая новые из текущего запуска
  - Убрана логика добавления дельты к существующему значению из манифеста
- **Исправлены дубли чатов в индексе** (`utils/history.py`)
  - Устранена проблема дублирования чатов в `index.html` при разных знаках chat_id (например, -100123 и 100123)
  - `_list_chat_ids_from_jsonl()` теперь извлекает реальный chat_id (с правильным знаком) из JSONL файлов
  - `_load_index_manifest()` автоматически удаляет дубли при загрузке манифеста, объединяя данные
  - При добавлении чатов из JSONL проверяется наличие по path_id (abs(chat_id)) для избежания дублей
  - Добавлен метод `_extract_chat_id_from_jsonl()` для извлечения правильного chat_id из JSONL

### Added
- **Скрипт очистки потерянных файлов** (`cleanup_orphaned_files.py`)
  - Удаление файлов из папок типов медиа, которые не упоминаются ни в одном архиве чата
  - Сканирование всех JSONL архивов и сбор путей к файлам из поля `downloaded_file`
  - Рекурсивное сканирование папок `video/`, `photo/`, `document/`, `audio/`, `voice/`, `video_note/`
  - Поиск потерянных файлов (разность множеств: файлы в папках минус файлы из архивов)
  - Режим `--dry-run` по умолчанию для безопасной проверки
  - Флаг `--force` для реального удаления
  - Детальное логирование и статистика операций
  - Обработка ошибок (права доступа, символические ссылки, системные файлы)
- **Поддержка ссылок и форматирования в сообщениях** (`utils/history.py`)
  - Сохранение entities (форматирование, ссылки) из Telegram сообщений в JSONL архив
  - Обработка всех типов entities: URL, TextUrl, Mention, Hashtag, Bold, Italic, Code, Pre, Underline, Strike, Blockquote, Spoiler
  - Преобразование Telegram deep links (`tg://` и `https://t.me/`) в ссылки на архивные HTML файлы
  - Поддержка ссылок на сообщения в других чатах: `tg://openmessage?chat_id=123&message_id=456` → `chat_123.html#message-456`
  - Поддержка ссылок формата `https://t.me/c/chat_id/message_id` → `chat_123.html#message-456`
  - Якоря для сообщений (`id="message-{msg_id}"`) для прямых ссылок на конкретные сообщения
  - JavaScript для автоматической прокрутки к якорю при загрузке страницы с подсветкой сообщения
  - CSS стили для форматирования: hashtag, spoiler (с возможностью раскрытия), code, pre, blockquote
  - Fallback обработка URL через regex для сообщений без entities
- **Автоматическое добавление чатов из ссылок** (`utils/history.py`, `utils/config.py`)
  - Извлечение chat_id из Telegram ссылок в сообщениях
  - Автоматическое добавление найденных чатов в список загрузок (`config.yaml`)
  - Опция `download_settings.auto_add_chats_from_links: false` для включения/выключения функции
  - Новые чаты добавляются с `enabled: false` по умолчанию (пользователь может включить при следующем запуске)
  - Метод `ConfigManager.add_chat_to_download_list()` для добавления чатов в конфигурацию
  - Логирование добавленных чатов для отслеживания
- **Жёсткая валидация скачанных медиафайлов** (`utils/validation.py`)
  - `validate_downloaded_media()`: проверка существования, размера, magic bytes для видео/аудио
  - Для видео: проверка сигнатур контейнеров (MP4/MOV, MKV/WebM, AVI, OGG, WAV)
  - Для аудио: проверка сигнатур (OGG, WAV, MP3 ID3/frame sync)
  - Проверка размера файла (не менее 95% от ожидаемого для предотвращения обрезанных загрузок)
- **Жёсткая валидация архивных файлов истории**
  - `validate_archive_file()`: проверка валидности JSONL/TXT архивов
  - Для JSONL: проверка наличия хотя бы одной валидной JSON-строки
  - Для TXT: проверка читаемости и непустоты
- **Настройки валидации в конфиге**
  - `download_settings.validate_downloads: true` (по умолчанию) — включение проверки медиа
  - `download_settings.validate_archives: true` (по умолчанию) — включение проверки архивов
- **Улучшенная обработка ошибок переключения DC**
  - Обработка `FileMigrateError` с увеличенной задержкой (10 сек) для переключения на другой DC
  - Обработка `IncompleteReadError` и сетевых ошибок при обрыве соединения
  - Автоматический retry с увеличенной задержкой для восстановления соединения

### Changed
- **Проверка архивов при `history_rebuild_if_missing`**
  - Вместо простой проверки `os.path.exists()` используется `validate_archive_file()`
  - Пустые или битые архивы теперь считаются невалидными и пересоздаются
- **Валидация после загрузки медиа**
  - После успешной загрузки файл проверяется на валидность перед добавлением в `downloaded_files`
  - Невалидные файлы не добавляются в список успешно загруженных и попадают в `failed_ids` для retry

### Fixed
- Исправлена обработка ошибок при переключении на другой DC (FileMigrateError)
- Исправлена обработка обрывов соединения при загрузке файлов из другого DC
- Улучшена надёжность загрузки файлов с увеличенными задержками для сетевых операций

## [3.1.0] - 2026-01-26

### Added
- Жёсткая валидация скачанных видео и архивных файлов
- Проверка magic bytes для видео/аудио контейнеров
- Валидация архивов истории (JSONL/TXT) при пересоздании
- Обработка ошибок переключения DC с увеличенными задержками
- Настройки `validate_downloads` и `validate_archives` в конфигурации

### Changed
- Улучшена проверка архивов: пустые/битые файлы пересоздаются
- Валидация медиа после загрузки перед добавлением в список успешных

### Fixed
- Обработка FileMigrateError при загрузке файлов из другого DC
- Обработка IncompleteReadError при обрыве соединения
- Увеличены задержки для retry при сетевых ошибках (10 сек вместо 5)
