# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- **Жёсткая валидация скачанных медиафайлов** (`utils/validation.py`)
  - `validate_downloaded_media()`: проверка существования, размера, magic bytes для видео/аудио
  - Для видео: проверка сигнатур контейнеров (MP4/MOV, MKV/WebM, AVI, OGG, WAV)
  - Для аудио: проверка сигнатур (OGG, WAV, MP3 ID3/frame sync)
  - Проверка размера файла (не менее 95% от ожидаемого для предотвращения обрезанных загрузок)
- **Жёсткая валидация архивных файлов истории**
  - `validate_archive_file()`: проверка валидности JSONL/TXT архивов
  - Для JSONL: проверка наличия хотя бы одной валидной JSON-строки
  - Для TXT: проверка читаемости и непустоты
- **Настройки валидации в конфиге**
  - `download_settings.validate_downloads: true` (по умолчанию) — включение проверки медиа
  - `download_settings.validate_archives: true` (по умолчанию) — включение проверки архивов
- **Улучшенная обработка ошибок переключения DC**
  - Обработка `FileMigrateError` с увеличенной задержкой (10 сек) для переключения на другой DC
  - Обработка `IncompleteReadError` и сетевых ошибок при обрыве соединения
  - Автоматический retry с увеличенной задержкой для восстановления соединения

### Changed
- **Проверка архивов при `history_rebuild_if_missing`**
  - Вместо простой проверки `os.path.exists()` используется `validate_archive_file()`
  - Пустые или битые архивы теперь считаются невалидными и пересоздаются
- **Валидация после загрузки медиа**
  - После успешной загрузки файл проверяется на валидность перед добавлением в `downloaded_files`
  - Невалидные файлы не добавляются в список успешно загруженных и попадают в `failed_ids` для retry

### Fixed
- Исправлена обработка ошибок при переключении на другой DC (FileMigrateError)
- Исправлена обработка обрывов соединения при загрузке файлов из другого DC
- Улучшена надёжность загрузки файлов с увеличенными задержками для сетевых операций

## [3.1.0] - 2026-01-26

### Added
- Жёсткая валидация скачанных видео и архивных файлов
- Проверка magic bytes для видео/аудио контейнеров
- Валидация архивов истории (JSONL/TXT) при пересоздании
- Обработка ошибок переключения DC с увеличенными задержками
- Настройки `validate_downloads` и `validate_archives` в конфигурации

### Changed
- Улучшена проверка архивов: пустые/битые файлы пересоздаются
- Валидация медиа после загрузки перед добавлением в список успешных

### Fixed
- Обработка FileMigrateError при загрузке файлов из другого DC
- Обработка IncompleteReadError при обрыве соединения
- Увеличены задержки для retry при сетевых ошибках (10 сек вместо 5)
