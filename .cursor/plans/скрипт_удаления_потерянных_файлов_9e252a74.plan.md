---
name: Скрипт удаления потерянных файлов
overview: Создать отдельный скрипт для удаления файлов из папок типов медиа, которые не связаны ни с одним архивом чата (не упоминаются в JSONL файлах)
todos:
  - id: create-script
    content: Создать файл cleanup_orphaned_files.py с основной структурой
    status: completed
  - id: implement-jsonl-reader
    content: Реализовать функцию чтения JSONL архивов и сбора путей downloaded_file
    status: completed
  - id: implement-media-scanner
    content: Реализовать функцию сканирования папок типов медиа
    status: completed
  - id: implement-orphan-finder
    content: Реализовать функцию поиска потерянных файлов (разность множеств)
    status: completed
  - id: implement-removal
    content: Реализовать функцию удаления файлов с обработкой ошибок
    status: completed
  - id: add-cli-args
    content: Добавить парсинг аргументов командной строки (base-directory, history-directory, dry-run)
    status: completed
  - id: add-logging
    content: Добавить логирование операций и статистики
    status: completed
  - id: add-safety-checks
    content: Добавить проверки безопасности (существование директорий, dry-run по умолчанию)
    status: completed
isProject: false
---

# План: Скрипт удаления потерянных файлов

## Цель

Создать отдельный скрипт `cleanup_orphaned_files.py`, который находит и удаляет файлы из папок типов медиа (video, photo, document, audio, voice, video_note), которые не упоминаются ни в одном архиве чата (JSONL файлах).

## Структура скрипта

### Основные компоненты

1. **Чтение архивов** (`_collect_archived_files`)

   - Сканирует `base_directory/history/` на наличие файлов `chat_*.jsonl`
   - Для каждого JSONL файла читает все строки и извлекает поле `downloaded_file`
   - Собирает множество всех путей к файлам, упомянутых в архивах
   - Использует функцию `_iter_jsonl` из `export_chat.py` как образец

2. **Сканирование папок медиа** (`_scan_media_directories`)

   - Сканирует папки типов медиа в `base_directory`: `video/`, `photo/`, `document/`, `audio/`, `voice/`, `video_note/`
   - Собирает множество всех файлов в этих папках (рекурсивно)
   - Игнорирует папку `history/` и другие служебные папки

3. **Поиск потерянных файлов** (`_find_orphaned_files`)

   - Вычисляет разность: файлы в папках медиа минус файлы из архивов
   - Возвращает список потерянных файлов

4. **Удаление файлов** (`_remove_files`)

   - Удаляет найденные потерянные файлы
   - Логирует каждое удаление
   - Обрабатывает ошибки (права доступа, файл уже удалён и т.д.)

5. **Главная функция** (`main`)

   - Парсит аргументы командной строки
   - Поддерживает `--dry-run` режим (только показ, без удаления)
   - Читает `base_directory` и `history_directory` из конфига или аргументов
   - Выводит статистику: сколько файлов найдено, сколько удалено

### Аргументы командной строки

- `--base-directory` (required): базовая директория (как в `download_settings.base_directory`)
- `--history-directory` (default: "history"): папка истории внутри base_directory
- `--dry-run`: режим проверки без удаления
- `--config`: путь к config.yaml (опционально, для чтения настроек)

### Логика работы

```
1. Прочитать все JSONL архивы → множество archived_files
2. Просканировать папки медиа → множество media_files
3. Найти разность: orphaned_files = media_files - archived_files
4. Если --dry-run: показать список, иначе удалить
5. Вывести статистику
```

### Обработка краевых случаев

- Пустые или битые JSONL файлы (пропускать с предупреждением)
- Файлы, упомянутые в архиве, но физически отсутствующие (не удалять, только логировать)
- Символические ссылки (проверять `os.path.islink()`)
- Пустые папки после удаления (опционально удалять)
- Права доступа (логировать ошибки, не падать)

### Файлы для создания/изменения

- **Новый файл**: `cleanup_orphaned_files.py` в корне проекта
  - Использует паттерн как в `export_chat.py` (argparse, функции-утилиты)
  - Импортирует `_iter_jsonl` или реализует аналогичную функцию
  - Логирование через `logging.getLogger(__name__)`

### Интеграция с существующим кодом

- Переиспользовать функцию `_iter_jsonl` из `export_chat.py` (вынести в общий модуль или импортировать)
- Использовать `_archive_chat_id_for_path` из `utils/history.py` для консистентности путей
- Следовать стилю кода проекта (типы, докстринги NumPy)

### Безопасность

- По умолчанию `--dry-run` или явное подтверждение перед удалением
- Детальное логирование всех операций
- Проверка, что `base_directory` существует и доступен
- Игнорирование системных файлов (`.gitkeep`, `.DS_Store` и т.д.)

## Пример использования

```bash
# Проверка без удаления
python cleanup_orphaned_files.py --base-directory /media/disk/Telegram --dry-run

# Реальное удаление
python cleanup_orphaned_files.py --base-directory /media/disk/Telegram
```

## Вывод скрипта

```
Сканирование архивов: найдено 15 чатов, 1234 файла в архивах
Сканирование папок медиа: найдено 1456 файлов
Потерянных файлов: 222

[DRY RUN] Будет удалено 222 файлов:
  /media/disk/Telegram/video/old_file1.mp4
  /media/disk/Telegram/photo/old_photo.jpg
  ...

Для реального удаления запустите без --dry-run
```