# Правила для ИИ-агента (Cursor) — Telegram Media Downloader

Эти правила — **инструкция по работе ИИ** в этом репозитории. Цель: получать точные, безопасные и минимально-инвазивные изменения кода + полезные объяснения.

## Язык и стиль общения

- **Всегда отвечай по-русски.**
- **Будь кратким и предметным.** Никаких «вот как можно…» без кода/конкретики.
- Если просили «исправить» — **делай правку в коде**, а не описывай идею.
- Если просили «объяснить» — **объясняй по существу**, со ссылками на конкретные места в коде/файлах.
- Если создаёшь git commit — **commit message на русском**.

## Главная цель и приоритеты

- **Не ломай существующее поведение.** Предпочитай маленькие диффы.
- **Сначала совместимость**, потом улучшения.
- **Тесты > догадки.** Если можно — запускай тесты/линтер после правок.
- Соблюдай архитектурные решения из `.cursor/architecture.md` (история, изоляция чатов, очистка памяти).

## Секреты, приватные данные и «опасные» файлы

- **Никогда не добавляй и не коммить**: `config.yaml`, `*.session`, `api-telegram.md`, любые ключи/токены/хэши/номера телефонов.
- Если в диффе/логах встречаются секреты — **немедленно вычищай** и добавляй в `.gitignore` при необходимости.
- Не предлагай пользователю вставлять реальные секреты в репозиторий. Допустимы только плейсхолдеры.

## Требования к изменениям в коде

- **Минимизируй поверхность изменений**: не рефактори «просто так».
- Правки должны быть:
  - **типобезопасными** (ориентир: `mypy.ini`),
  - **линт-совместимыми** (ориентир: `pylintrc`),
  - с **докстрингами** в стиле NumPy там, где уместно.
- Новые модули в `utils/` должны иметь:
  - корректные импорты,
  - минимум глобального состояния,
  - логирование через `logging.getLogger(__name__)`.

## Проект-специфика: Telegram / Telethon

- Прокси для Telethon ожидается в виде кортежа:
  - `(proxy_type, addr, port, rdns, username, password)`.
- Любая функциональность, завязанная на прокси, должна:
  - быть **опциональной**,
  - иметь понятные ошибки/предупреждения,
  - не ломать запуск без прокси.

## Проект-специфика: история и изоляция данных

- Message ID **уникален только внутри чата**.
- Любая привязка «сообщение → путь к файлу» при мульти-чате должна использовать ключ:
  - **`(chat_id, message_id)`**, а не просто `message_id`.
- После завершения обработки чата **очищай накопленные структуры** для этого чата (см. `.cursor/architecture.md`).

## Конфигурация

- Источник пользовательской конфигурации: `config.yaml` (в git не хранится).
- Пример и документация по настройкам: `config.yaml.example`.
- Любые новые опции конфигурации должны:
  - иметь дефолты,
  - быть документированы в `config.yaml.example`,
  - по возможности быть обратно-совместимыми.

## Документация

- При добавлении фичи обновляй **минимально необходимое**:
  - `README.md` (пользовательское),
  - `docs/*` (техническое),
  - `config.yaml.example` (опции).
- Документация — по-русски (если нет явного запроса на английский).

## Тестирование и проверка качества

- После существенных правок в Python-коде старайся прогнать:
  - `pytest`
  - и/или целевые тесты из `tests/`.
- Если меняешь файлы в `utils/`, сначала/потом проверь тесты из `tests/utils/`.
- Если правка затрагивает конфиг/парсер — добавь/обнови тест на регрессию.

## Работа с инструментами и репозиторием

- Перед коммитом:
  - убедись, что в индекс не попали секреты/сессии,
  - проверь `git diff` на случайные файлы/мусор.
- Не меняй глобальные настройки git.
- Не запускай интерактивные команды, требующие ввода (например, `git rebase -i`).

## Правила формата ответов ИИ (для Cursor)

- При показе кода из репозитория используй ссылки на файл и диапазон строк (code reference).
- Для нового кода (которого нет в репо) — обычный markdown-блок с языком.
- Если есть несколько вариантов решения — выбери один и сделай его; альтернативы упоминай кратко.

